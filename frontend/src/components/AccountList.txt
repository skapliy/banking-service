<template>
  <div class="accounts-container">
    <!-- –®–∞–ø–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
    <div class="header-row">
      <h2 class="page-title">–ö–æ–ø–∏–ª–∫–∏</h2>
      <div class="action-buttons">
        <button
          class="action-button create-button"
          @click="showCreateAccount"
          title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å—á–µ—Ç"
        >
          +
        </button>
        <button
          class="action-button rate-button"
          title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞–≤–∫—É –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü"
          @click="showGlobalRateModal"
        >
          %
        </button>
        <div class="log-level-container">
          <button
            class="action-button log-level-button"
            @click="openLogLevelSelector"
            title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"
          >
            üìù
          </button>
          <transition name="fade">
            <div v-if="showLogLevelSelector" class="log-level-selector">
              <select id="log-level" v-model="logLevel">
                <option value="INFO">INFO</option>
                <option value="DEBUG">DEBUG</option>
                <option value="WARNING">WARNING</option>
              </select>
            </div>
          </transition>
      </div>
    </div>
   </div> 

    <!-- –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—à–∏–±–∫–∏ -->
    <div v-if="loading" class="loading">
      –ó–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç–æ–≤...
      <div class="debug-info" style="font-size: 0.8em; color: #999; margin-top: 10px;">
        –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {{ new Date().toLocaleTimeString() }}
      </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div v-else>
      <!-- –ú–æ–±–∏–ª—å–Ω—ã–π –≤–∏–¥ (–∫–∞—Ä—Ç–æ—á–∫–∏) -->
      <div class="accounts-mobile">
        <div 
          v-for="account in accounts" 
          :key="account.id"
          class="account-card"
        >
          <div class="account-header" @click="toggleTransactions(account.id)">
            <div class="account-name-container">
              <span class="account-name">
                {{ account.name }}
                <span
                  v-if="account.current_interest_rate !== undefined && account.current_interest_rate !== null"
                  class="interest-rate-label"
                >
                  ({{ account.current_interest_rate }}%)
                </span>
                <span v-else class="interest-rate-label">(--%)</span>
              </span>
              <span class="expand-icon">
                {{ expandedAccountId === account.id ? "‚ñ≤" : "‚ñº" }}
              </span>
            </div>
            
            <div class="balance-container">
              <div 
                class="actual-balance" 
                :class="{ negative: account.current_period && account.current_period.current_balance < 0 }"
              >
                {{ formatBalance(account.current_period.current_balance) }}
              </div>
              <div class="projected-balance">
                {{ formatBalance(account.current_period.projected_eom_balance) }}
              </div>
            </div>
          </div>
          
          <div class="account-actions">
            <button
              class="action-button transaction-button"
              @click="showAddTransaction(account.id, account.name)"
              title="–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é"
            >
              ¬±
            </button>
            <DeleteAccount
              :account-id="account.id"
              @deleted="loadAccounts"
            />
          </div>
          
          <!-- –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (—Å–≤–µ—Ä–Ω—É—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
          <div class="history-section" v-if="expandedAccountId === account.id">
            <div class="history-grid">
              <div 
                v-for="monthKey in lastThreeMonths" 
                :key="monthKey"
                class="month-card"
              >
                <div class="month-name">{{ formatMonthYear(monthKey) }}</div>
                <div 
                  v-if="account.previous_months && account.previous_months[monthKey]"
                  class="month-data"
                >
                  <div class="balance">
                    {{ formatBalance(account.previous_months[monthKey].end_balance) }}
                  </div>
                  <div class="interest">
                    +{{ formatBalance(account.previous_months[monthKey].interest_accrued) }}
                  </div>
                </div>
                <div v-else class="month-data-na">-</div>
              </div>
            </div>
          </div>
          
          <!-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–µ—Å–ª–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã) -->
          <div
            v-if="expandedAccountId === account.id"
            class="transactions-wrapper"
          >
            <div class="details-wrapper" :style="{ maxHeight: expandedAccountId === account.id ? '500px' : '0px' }">
                 <TransactionList
                :account-id="account.id"
                :account-name="account.name"
                @transactions-updated="handleTransactionsUpdate"
                :key="`${account.id}-tx`"
              />
            </div>
             </div>
        </div>
        
        <!-- –ò—Ç–æ–≥–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="account-card totals-card">
          <div class="account-header">
            <span class="account-name">–ò—Ç–æ–≥–æ:</span>
            <div class="balance-container">
              <div class="actual-balance">
                {{ formatBalance(currentPeriodTotals.totalCurrentBalance) }}
              </div>
              <div class="projected-balance">
                {{ formatBalance(currentPeriodTotals.totalProjectedEomBalance) }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- –î–µ—Å–∫—Ç–æ–ø–Ω—ã–π –≤–∏–¥ (—Ç–∞–±–ª–∏—Ü–∞) - —Å–∫—Ä—ã—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö -->
      <div class="accounts-desktop">
        <table class="accounts-table">
          <thead>
            <tr>
              <th>–°—á–µ—Ç</th>
              <th v-for="monthKey in lastThreeMonths" :key="monthKey">
                {{ formatMonthYear(monthKey) }}
              </th>
              <th>–ë–∞–ª–∞–Ω—Å / –ü—Ä–æ–≥–Ω–æ–∑</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody>
            <template v-for="account in accounts" :key="account.id">
              <tr>
                <td>
                  <span
                    class="account-name clickable"
                    @click="toggleTransactions(account.id)"
                    :title="`${expandedAccountId === account.id ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å'} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è ${account.name}`"
                    :class="{ expanded: expandedAccountId === account.id }"
                  >
                    {{ account.name }}
                    <span
                      v-if="account.current_interest_rate !== undefined && account.current_interest_rate !== null"
                      class="interest-rate-label"
                      :title="`–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞: ${account.current_interest_rate}%`"
                    >
                      ({{ account.current_interest_rate }}%)
                    </span>
                    <span
                      v-else
                      class="interest-rate-label"
                      title="–°—Ç–∞–≤–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
                    >
                      (-%)
                    </span>
                    <span class="expand-icon">{{
                      expandedAccountId === account.id ? "‚ñ≤" : "‚ñº"
                    }}</span>
                  </span>
                </td>
                <td
                  v-for="monthKey in lastThreeMonths"
                  :key="monthKey"
                  class="historical-cell"
                >
                  <div
                    class="monthly-data"
                    v-if="account.previous_months && account.previous_months[monthKey]"
                  >
                    <div class="balance" title="–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞">
                      {{ formatBalance(account.previous_months[monthKey].end_balance) }}
                    </div>
                    <div class="interest" title="–ù–∞—á–∏—Å–ª–µ–Ω–æ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –∑–∞ –º–µ—Å—è—Ü">
                      +{{ formatBalance(account.previous_months[monthKey].interest_accrued) }}
                    </div>
                  </div>
                  <div v-else class="monthly-data-na">-</div>
                </td>
                <td
                  :class="{ negative: account.current_period && account.current_period.current_balance < 0 }"
                >
                  <div class="balance-container">
                    <div class="actual-balance" title="–¢–µ–∫—É—â–∏–π —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å">
                      {{ formatBalance(account.current_period.current_balance) }}
                    </div>
                    <div
                      class="projected-balance"
                      :title="`–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∫–æ–Ω–µ—Ü ${formatMonthYear(currentMonthStr)} —Å —É—á–µ—Ç–æ–º –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ (${formatValueForTitle(account.current_period.projected_interest)} ‚ÇΩ)`"
                    >
                      {{ formatBalance(account.current_period.projected_eom_balance) }}
                    </div>
                  </div>
                </td>
                <td class="actions">
                  <button
                    class="action-button transaction-button"
                    @click="showAddTransaction(account.id, account.name)"
                    title="–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é"
                  >
                    ¬±
                  </button>
                  <DeleteAccount
                    :account-id="account.id"
                    @deleted="loadAccounts"
                  />
                </td>
              </tr>
              <tr
                v-if="expandedAccountId === account.id"
                class="transaction-details-row"
              >
                <td :colspan="lastThreeMonths.length + 3">
                  <div class="details-wrapper" :style="{ maxHeight: expandedAccountId === account.id ? '1000px' : '0px' }">
                    <TransactionList
                      :account-id="account.id"
                      :account-name="account.name"
                      @transactions-updated="handleTransactionsUpdate"
                      :key="`${account.id}-tx`"
                    />
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
          <tfoot>
            <tr class="totals-row">
              <td><strong>–ò—Ç–æ–≥–æ:</strong></td>
              <td
                v-for="monthKey in lastThreeMonths"
                :key="`${monthKey}-total`"
                class="historical-cell totals-cell"
              >
                <div v-if="totalsByMonth[monthKey]" class="monthly-data">
                  <div class="balance" title="–°—É–º–º–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –Ω–∞ –∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞">
                    {{ formatBalance(totalsByMonth[monthKey].totalEndBalance) }}
                  </div>
                  <div
                    class="interest"
                    title="–°—É–º–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –∑–∞ –º–µ—Å—è—Ü"
                  >
                    +{{ formatBalance(totalsByMonth[monthKey].totalInterestAccrued) }}
                  </div>
                </div>
                <div v-else class="monthly-data-na">-</div>
              </td>
              <td class="totals-cell">
                <div class="balance-container">
                  <div class="actual-balance" title="–°—É–º–º–∞ —Ç–µ–∫—É—â–∏—Ö –±–∞–ª–∞–Ω—Å–æ–≤">
                    {{ formatBalance(currentPeriodTotals.totalCurrentBalance) }}
                  </div>
                  <div
                    class="projected-balance"
                    title="–°—É–º–º–∞ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã—Ö –±–∞–ª–∞–Ω—Å–æ–≤ –Ω–∞ –∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞"
                  >
                    {{ formatBalance(currentPeriodTotals.totalProjectedEomBalance) }}
                  </div>
                </div>
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
      <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
      <div v-if="showingAddTransaction" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>–ù–æ–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: {{ selectedAccountForModal?.name }}</h3>
            <button @click="closeAddTransaction" class="close-button">&times;</button>
          </div>
          <AddTransaction
            v-if="selectedAccountForModal"
            :account-id="selectedAccountForModal.id"
            @transaction-added="onActionComplete"
            @close="closeAddTransaction"
          />
        </div>
      </div>

      <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞ -->
      <div v-if="showingCreateAccount" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å—á–µ—Ç</h3>
            <button @click="closeCreateAccount" class="close-button">&times;</button>
          </div>
          <CreateAccount
            @account-created="onActionComplete"
            @close="closeCreateAccount"
          />
        </div>
      </div>

      <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å—Ç–∞–≤–∫–∏ -->
      <div v-if="showingGlobalRateModal" class="modal">
        <div class="modal-content small">
          <div class="modal-header">
            <h3>–°—Ç–∞–≤–∫–∞ –∑–∞ {{ formatMonthYear(currentMonthStr) }}</h3>
            <button @click="closeGlobalRateModal" class="close-button">&times;</button>
          </div>
          <div class="change-rate-form">
            <label for="global-rate-input">–ù–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ (%):</label>
            <input
              type="number"
              id="global-rate-input"
              v-model.number="newInterestRate"
              min="0"
              step="0.01"
              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 15.00"
            />
            <div class="modal-actions">
              <button @click="saveGlobalInterestRate" class="save-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button @click="closeGlobalRateModal" class="cancel-button">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <p v-if="rateChangeError" class="error">{{ rateChangeError }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
/* === –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å === */
.account-actions {
  border-top: 1px solid #f1f1f1; /* –¢–æ–Ω–∫–∞—è –ª–∏–Ω–∏—è –Ω–∞–¥ –∫–Ω–æ–ø–∫–∞–º–∏ */
  display: flex;
  gap: 10px;
  justify-content: flex-end; /* –ö–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞ */
  margin-top: 6px;
  padding-top: 6px;
}

.account-card {
  background-color: #fff;
  border: 1px solid #e9ecef; /* –°–≤–µ—Ç–ª–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ */
  border-radius: 5px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* –ú—è–≥–∫–∞—è —Ç–µ–Ω—å */
  padding: 15px; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø */
}

.account-header {
  align-items: center;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  padding-bottom: 6px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ —à–∞–ø–∫–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ */
  /* border-bottom: 1px solid #eee; */ /* –£–±—Ä–∞–ª –≥—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å */
  /* margin-bottom: 10px; */
}

.account-name {
  font-size: 1.1rem;
  font-weight: 600;
  overflow: hidden;
  text-overflow: ellipsis; /* –ú–Ω–æ–≥–æ—Ç–æ—á–∏–µ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∏–º–µ–Ω */
  white-space: nowrap;
}

.account-name-container {
  align-items: center;
  display: flex;
  gap: 8px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –∏–º–µ–Ω–∏ */
  /* flex-grow: 1; */ /* –ß—Ç–æ–±—ã –∑–∞–Ω–∏–º–∞–ª–æ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ */
  overflow: hidden; /* –û–±—Ä–µ–∑–∞—Ç—å –¥–ª–∏–Ω–Ω–æ–µ –∏–º—è */
}

.accounts-container {
  max-width: 100%;
  overflow-x: hidden; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
  padding: 1px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö –æ—Ç—Å—Ç—É–ø–æ–≤ –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
}

.accounts-desktop {
  display: none;
}

.accounts-mobile {
  display: flex;
  flex-direction: column;
  gap: 5px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ */
  padding: 0 3px; /* –ù–µ–±–æ–ª—å—à–∏–µ –æ—Ç—Å—Ç—É–ø—ã –ø–æ –±–æ–∫–∞–º */
}

.accounts-table {
  border-collapse: collapse;
  margin-top: 10px; /* –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
  width: 100%;
}

.accounts-table .actions { 
  text-align: center; 
  white-space: nowrap; 
  width: 100px; 
}

.accounts-table .actual-balance { 
  font-weight: 600; 
}

.accounts-table .balance-container { 
  display: flex; 
  flex-direction: column; 
  gap: 3px; 
  text-align: right; 
}

.accounts-table .details-wrapper { /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ */
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease-out;
}

.accounts-table .historical-cell { 
  min-width: 100px; 
  text-align: right; 
}

.accounts-table .monthly-data .balance { 
  font-weight: 500; 
}

.accounts-table .monthly-data .interest { 
  color: #198754; 
  font-size: 0.85em; 
}

.accounts-table .monthly-data-na { 
  color: #adb5bd; 
  font-style: italic; 
  text-align: center; 
}

.accounts-table .projected-balance { 
  color: #0d6efd; 
  font-size: 0.9em; 
}

.accounts-table .transaction-details-row td {
  background-color: #fdfdfd;
  border-bottom: 1px solid #dee2e6; /* –ì—Ä–∞–Ω–∏—Ü–∞ —Å–Ω–∏–∑—É –∫–∞–∫ —É –æ–±—ã—á–Ω—ã—Ö —Å—Ç—Ä–æ–∫ */
  border-top: 1px dashed #e0e0e0;
  padding: 0;
}

.accounts-table td.negative .actual-balance { 
  color: #dc3545; 
}

.accounts-table td,
.accounts-table th {
  border-bottom: 1px solid #dee2e6;
  padding: 10px 12px;
  vertical-align: middle;
}

.accounts-table tfoot .totals-cell { 
  text-align: right; 
}

.accounts-table tfoot .totals-cell .balance-container,
.accounts-table tfoot .totals-cell .monthly-data { 
  text-align: right; 
}

.accounts-table tfoot .totals-cell .monthly-data .interest { 
  color: #198754; 
}

.accounts-table tfoot .totals-cell .projected-balance { 
  color: #0d6efd; 
}

.accounts-table tfoot .totals-row td {
  background-color: #f8f9fa;
  border-top: 2px solid #dee2e6;
  font-weight: bold;
}

.accounts-table th {
  background-color: #f8f9fa;
  font-weight: 600;
  text-align: left;
  white-space: nowrap;
}

.accounts-table th:last-child { 
  text-align: center; 
}

.accounts-table th:nth-child(1) { 
  text-align: left; 
}

.accounts-table th:nth-child(n+2) { 
  text-align: right; 
}

.action-button,
:deep(.action-button) /* –î–ª—è –∫–Ω–æ–ø–æ–∫ –≤–Ω—É—Ç—Ä–∏ DeleteAccount */
{
  align-items: center;
  background-color: #fff;
  border: 1px solid;
  border-radius: 5px; /* –ß—É—Ç—å –±–æ–ª—å—à–µ —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è */
  box-sizing: border-box;
  cursor: pointer;
  display: inline-flex;
  flex-shrink: 0; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–æ–∫ –≤ flex –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ */
  font-size: 1.4em; /* –†–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏/—Å–∏–º–≤–æ–ª–∞ */
  font-weight: normal;
  height: 32px;  /* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä */
  justify-content: center;
  line-height: 1;
  margin-right: 10px;
  overflow: hidden;
  padding: 0;
  text-align: center;
  transition: background-color 0.2s, color 0.2s, border-color 0.2s;
  vertical-align: middle;
  width: 32px;   /* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä */
}

.action-button.create-button { 
  border-color: #198754; 
  color: #198754; 
}

.action-button.create-button:hover { 
  background-color: #198754; 
  color: white; 
}

.action-button.rate-button { 
  border-color: #ffc107; 
  color: #ffc107; 
}

.action-button.rate-button:hover { 
  background-color: #ffc107; 
  color: white; 
}

.action-button.transaction-button { 
  border-color: #0dcaf0; 
  color: #0dcaf0; 
}

.action-button.transaction-button:hover { 
  background-color: #0dcaf0; 
  color: white; 
}

.action-buttons {
  display: flex;
  gap: 10px; /* –£–≤–µ–ª–∏—á–µ–Ω –æ—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
}

.actual-balance {
  font-size: 1.1rem; /* –†–∞–∑–º–µ—Ä –∫–∞–∫ —É –∏–º–µ–Ω–∏ —Å—á–µ—Ç–∞ */
  font-weight: 600;
  white-space: nowrap;
}

.actual-balance.negative {
  color: #dc3545;
}

.balance-container {
  flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å –±–∞–ª–∞–Ω—Å */
  padding-left: 10px; /* –û—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ –æ—Ç –±–∞–ª–∞–Ω—Å–∞ */
  text-align: right;
}

.change-rate-form {
  display: flex;
  flex-direction: column;
  gap: 15px;
  padding: 20px; /* –£–≤–µ–ª–∏—á–µ–Ω—ã –æ—Ç—Å—Ç—É–ø—ã */
}

.change-rate-form .cancel-button { 
  background-color: #6c757d; 
  border: none; 
  border-radius: 5px; 
  color: white; 
  cursor: pointer; 
  font-weight: 500; 
  padding: 9px 18px; 
}

.change-rate-form .error { 
  color: #dc3545; 
  font-size: 0.9em; 
  margin-top: 5px;
  text-align: center; 
}

.change-rate-form input {
  border: 1px solid #ced4da;
  border-radius: 5px;
  font-size: 1em;
  padding: 10px 12px;
}

.change-rate-form input:focus {
  border-color: #86b7fe;
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  outline: none;
}

.change-rate-form label { 
  font-weight: 500; 
  margin-bottom: -8px; 
}

.change-rate-form .modal-actions { 
  display: flex; 
  gap: 10px; 
  justify-content: flex-end; 
  margin-top: 15px; 
}

.change-rate-form .save-button { 
  background-color: #198754; 
  border: none; 
  border-radius: 5px; 
  color: white; 
  cursor: pointer; 
  font-weight: 500; 
  padding: 9px 18px; 
}

.close-button {
  background: none;
  border: none;
  color: #6c757d;
  cursor: pointer;
  font-size: 1.6rem; /* –ö—Ä—É–ø–Ω–µ–µ –∫—Ä–µ—Å—Ç–∏–∫ */
  font-weight: bold;
  line-height: 1;
  padding: 0 5px; /* –ù–µ–±–æ–ª—å—à–æ–π –ø–∞–¥–¥–∏–Ω–≥ –¥–ª—è –∫–ª–∏–∫–∞ */
}

.close-button:hover {
  color: #343a40;
}

.details-wrapper {
  max-height: 0; /* –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - —Å–∫—Ä—ã—Ç–æ */
  overflow: hidden;
  transition: max-height 0.4s ease-out; /* –ê–Ω–∏–º–∞—Ü–∏—è */
}

.error {
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  border-radius: 4px;
  color: #dc3545;
}

.expand-icon {
  color: #888;
  flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å */
  font-size: 0.8em;
}

.fade-enter, .fade-leave-to {
  opacity: 0;
}

.fade-enter-active, .fade-leave-active {
  transition: opacity 0.3s;
}

.header-row {
  align-items: center;
  display: flex;
  flex-wrap: wrap; /* –ü–µ—Ä–µ–Ω–æ—Å –∫–Ω–æ–ø–æ–∫ –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –Ω–∞ –º–∞–ª. —ç–∫—Ä–∞–Ω–∞—Ö */
  gap: 10px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ –∫–Ω–æ–ø–∫–∞–º–∏ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ */
  justify-content: space-between; /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ª–µ–≤–∞, –∫–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞ */
  margin-bottom: 20px; /* –ë–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
  padding: 0 17px; /* –û—Ç—Å—Ç—É–ø—ã –ø–æ –±–æ–∫–∞–º –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
}

.history-grid {
  display: grid;
  gap: 10px;
  grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ */
}

.history-section,
.transactions-wrapper {
  border-top: 1px dashed #e0e0e0; /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–ª—è –¥–æ–ø. —Å–µ–∫—Ü–∏–π */
  margin-top: 15px;
  padding-top: 15px;
}

.interest-rate-label {
  color: #6c757d;
  flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞—Ç—å */
  font-size: 0.8em;
  font-weight: normal;
  white-space: nowrap;
}

.loading, .error {
  font-size: 1em;
  margin: 15px 0;
  padding: 20px 15px; /* –î–æ–±–∞–≤–ª–µ–Ω –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –ø–∞–¥–¥–∏–Ω–≥ */
  text-align: center;
}

.log-level-container {
  display: inline-block;
  position: relative;
}

.log-level-selector {
  background-color: #ffffff;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  margin-top: 5px;
  min-width: 100px;
  padding: 5px;
  position: absolute;
  right: 0;
  top: 100%;
  z-index: 100;
}

.log-level-selector select {
  border: 1px solid #ced4da;
  border-radius: 4px;
  padding: 5px;
  width: 100%;
}

.modal {
  align-items: center;
  background-color: rgba(0, 0, 0, 0.6); /* –ß—É—Ç—å —Ç–µ–º–Ω–µ–µ —Ñ–æ–Ω */
  box-sizing: border-box;
  display: flex;
  height: 100%;
  justify-content: center;
  left: 0;
  padding: 15px; /* –û—Ç—Å—Ç—É–ø—ã, —á—Ç–æ–±—ã –º–æ–¥–∞–ª–∫–∞ –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª–∞ –∫ –∫—Ä–∞—è–º */
  position: fixed;
  top: 0;
  width: 100%;
  z-index: 1000;
}

.modal-content {
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); /* –ó–∞–º–µ—Ç–Ω–µ–µ —Ç–µ–Ω—å */
  display: flex; /* –ß—Ç–æ–±—ã flex-direction —Ä–∞–±–æ—Ç–∞–ª */
  flex-direction: column; /* –®–∞–ø–∫–∞ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç –¥—Ä—É–≥ –ø–æ–¥ –¥—Ä—É–≥–æ–º */
  max-height: calc(100vh - 40px); /* –ú–∞–∫—Å –≤—ã—Å–æ—Ç–∞ —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏ */
  max-width: 500px; /* –ú–∞–∫—Å —à–∏—Ä–∏–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
  overflow-y: auto; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–∫—Ä–æ–ª–ª, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –≤–ª–µ–∑–∞–µ—Ç */
  width: 100%; /* –®–∏—Ä–∏–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
}

.modal-content.small {
  max-width: 380px; /* –£–≤–µ–ª–∏—á–µ–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–ª—è —Ñ–æ—Ä–º—ã —Å—Ç–∞–≤–∫–∏ */
}

.modal-header {
  align-items: center;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  flex-shrink: 0; /* –®–∞–ø–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ —Å–∂–∏–º–∞—Ç—å—Å—è */
  justify-content: space-between;
  padding: 12px 15px; /* –£–º–µ–Ω—å—à–µ–Ω –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –ø–∞–¥–¥–∏–Ω–≥ */
}

.modal-header h3 {
  font-size: 1.2rem;
  font-weight: 600;
  margin: 0;
}

.month-card {
  background-color: #f8f9fa;
  border: 1px solid #eee;
  border-radius: 6px;
  padding: 8px;
  text-align: center;
}

.month-data { 
  display: flex; 
  flex-direction: column; 
  gap: 2px; 
}

.month-data .balance { 
  font-size: 0.9em; 
  font-weight: 500; 
}

.month-data .interest { 
  color: #198754; 
  font-size: 0.8em; 
}

.month-data-na { 
  color: #adb5bd; 
  font-size: 0.9em; 
  font-style: italic; 
}

.month-name {
  color: #495057;
  font-size: 0.8em;
  font-weight: 500;
  margin-bottom: 5px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.page-title {
  font-size: 1.6rem; /* –ß—É—Ç—å –±–æ–ª—å—à–µ */
  font-weight: 600;
  margin: 0;
}

.projected-balance {
  color: #0d6efd;
  font-size: 0.9em;
  white-space: nowrap;
}

.totals-card {
  background-color: #f8f9fa;
  border-color: #dee2e6;
  box-shadow: none;
}

.totals-card .account-name {
  font-weight: bold;
}

:deep(.action-button.delete-button) { 
  border-color: #dc3545; 
  color: #dc3545; 
}

:deep(.action-button.delete-button:hover) { 
  background-color: #dc3545; 
  color: white; 
}

:deep(.accounts-table .transaction-details-row .transaction-list) {
  border: none;
  box-shadow: none;
  padding: 15px; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø */
}

:deep(.accounts-table .transaction-details-row .transaction-list .header) {
  display: none;
}

:deep(.accounts-table .transaction-details-row .transactions-table-container) {
  border-top: 1px solid #eee;
  margin-top: 10px;
}

:deep(.transactions-wrapper .transaction-list) {
  /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã/—Ä–∞–º–∫–∏ —É —Å–∞–º–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ TransactionList */
  border: none;
  box-shadow: none;
  padding: 0;
}

:deep(.transactions-wrapper .transaction-list .header) {
  display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–Ω—É—Ç—Ä–∏ */
}

:deep(.transactions-wrapper .transaction-list .transactions-table-container) {
  /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –≤–Ω—É—Ç—Ä–∏ */
  border-top: 1px solid #eee;
  margin-top: 0; /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–π –æ—Ç—Å—Ç—É–ø */
  max-height: 300px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π */
  padding: 0; /* –£–±–∏—Ä–∞–µ–º –ø–∞–¥–¥–∏–Ω–≥ —Å–ø—Ä–∞–≤–∞, –µ—Å–ª–∏ –æ–Ω –Ω–µ –Ω—É–∂–µ–Ω –≤ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ */
}

/* === –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è Desktop/Mobile === */
@media (min-width: 992px) { /* –ò—Å–ø–æ–ª—å–∑—É–µ–º breakpoint –ø–æ–±–æ–ª—å—à–µ (lg) –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ —Ç–∞–±–ª–∏—Ü—É */
  .accounts-container {
    padding: 10px 20px; /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
  }

  .accounts-desktop {
    display: block; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
  }

  .accounts-mobile {
    display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
  }

  .header-row {
    padding: 0; /* –£–±–∏—Ä–∞–µ–º –±–æ–∫–æ–≤—ã–µ –æ—Ç—Å—Ç—É–ø—ã —à–∞–ø–∫–∏ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
  }

  .modal-content {
    width: auto; /* –ü–æ–∑–≤–æ–ª—è–µ–º –º–æ–¥–∞–ª–∫–µ –±—ã—Ç—å —à–∏—Ä–µ */
    /* min-width: 500px; */ /* –ú–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å */
  }
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
@media (max-width: 400px) {
  .account-header {
    flex-wrap: wrap; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å –±–∞–ª–∞–Ω—Å–∞ –ø–æ–¥ –∏–º—è */
    gap: 5px;
  }

  .account-name {
    font-size: 1.0rem; /* –ß—É—Ç—å –º–µ–Ω—å—à–µ –∏–º—è */
  }

  .actual-balance {
    font-size: 1.0rem;
  }

  .balance-container {
    /* width: 100%; */ /* –ú–æ–∂–Ω–æ —Ä–∞—Å—Ç—è–Ω—É—Ç—å –±–∞–ª–∞–Ω—Å */
    padding-left: 0;
    text-align: right; /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ–Ω —Å–ø—Ä–∞–≤–∞ */
  }

  .history-grid {
    gap: 8px;
    grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); /* –ï—â–µ –º–µ–Ω—å—à–µ –∫–æ–ª–æ–Ω–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ */
  }

  .modal-content {
    max-width: calc(100% - 20px); /* –ú–æ–¥–∞–ª–∫–∞ —á—É—Ç—å —É–∂–µ */
  }

  .modal-header h3 {
    font-size: 1.1rem;
  }

  .page-title {
    font-size: 1.4rem; /* –£–º–µ–Ω—å—à–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
  }
}
</style>

<script>
import axios from 'axios';
import TransactionList from './TransactionList.vue';
import AddTransaction from './AddTransaction.vue';
import CreateAccount from './CreateAccount.vue';
import DeleteAccount from './DeleteAccount.vue';

export default {
  name: 'AccountList',
  components: {
    TransactionList,
    AddTransaction,
    CreateAccount,
    DeleteAccount,
  },
  data() {
    return {
      accounts: [],
      loading: true,
      error: null,
      showingAddTransaction: false,
      showingCreateAccount: false,
      showingGlobalRateModal: false,
      expandedAccountId: null, // ID –∞–∫–∫–∞—É–Ω—Ç–∞, —á—å–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–µ–π—á–∞—Å –ø–æ–∫–∞–∑–∞–Ω—ã
      selectedAccountForModal: null, // –î–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
      newInterestRate: null,
      rateChangeError: null,
      logLevel: 'INFO', // –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
      showLogLevelSelector: false, // –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–∏–¥–∏–º–æ—Å—Ç–∏ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —É—Ä–æ–≤–Ω—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    };
  },
  computed: {
    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ —Å –∫–ª—é—á–∞–º–∏ 3-—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –º–µ—Å—è—Ü–µ–≤ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ).
     */
    lastThreeMonths() {
      const months = [];
      const today = new Date();
      for (let i = 3; i >= 1; i--) {
        const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const monthStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        months.push(monthStr);
      }
      return months;
    },
    
    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM.
     */
    currentMonthStr() {
      const today = new Date();
      return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    },
    
    /**
     * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—â–∏–µ —Å—É–º–º—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞.
     */
    currentPeriodTotals() {
      return this.accounts.reduce((totals, account) => {
        // –°—É–º–º–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
        const currentBalance = parseFloat(account.current_period?.current_balance || 0);
        totals.totalCurrentBalance += isNaN(currentBalance) ? 0 : currentBalance;
        
        // –°—É–º–º–∏—Ä—É–µ–º –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π –±–∞–ª–∞–Ω—Å
        const projectedBalance = parseFloat(account.current_period?.projected_eom_balance || 0);
        totals.totalProjectedEomBalance += isNaN(projectedBalance) ? 0 : projectedBalance;
        
        return totals;
      }, { totalCurrentBalance: 0, totalProjectedEomBalance: 0 });
    },
    
    /**
     * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—â–∏–µ —Å—É–º–º—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –º–µ—Å—è—Ü–µ–≤.
     */
    totalsByMonth() {
      const monthlyTotals = {};
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
      this.lastThreeMonths.forEach(monthKey => {
        monthlyTotals[monthKey] = { totalEndBalance: 0, totalInterestAccrued: 0 };
      });
      
      // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å—á–µ—Ç–∞–º
      this.accounts.forEach(account => {
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –º–µ—Å—è—Ü–∞–º, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –∫–ª—é—á–∏ –≤ –∏—Ç–æ–≥–∞—Ö
        this.lastThreeMonths.forEach(monthKey => {
          const monthData = account.previous_months?.[monthKey];
          if (monthData) {
            // –°—É–º–º–∏—Ä—É–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ –∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞
            const endBalance = parseFloat(monthData.end_balance || 0);
            monthlyTotals[monthKey].totalEndBalance += isNaN(endBalance) ? 0 : endBalance;
            
            // –°—É–º–º–∏—Ä—É–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
            const interestAccrued = parseFloat(monthData.interest_accrued || 0);
            monthlyTotals[monthKey].totalInterestAccrued += isNaN(interestAccrued) ? 0 : interestAccrued;
          }
        });
      });
      
      // –û–∫—Ä—É–≥–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã –¥–æ 2 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
      Object.keys(monthlyTotals).forEach(monthKey => {
        monthlyTotals[monthKey].totalEndBalance = parseFloat(monthlyTotals[monthKey].totalEndBalance.toFixed(2));
        monthlyTotals[monthKey].totalInterestAccrued = parseFloat(monthlyTotals[monthKey].totalInterestAccrued.toFixed(2));
      });
      
      return monthlyTotals;
    }
  },
  methods: {
    openLogLevelSelector() {
      this.showLogLevelSelector = !this.showLogLevelSelector;
    },

    log(message, level) {
      if (
        (level === 'DEBUG' && this.logLevel !== 'DEBUG') ||
        (level === 'WARNING' && this.logLevel === 'INFO')
      ) return;

      switch (level) {
        case 'INFO': console.info(message); break;
        case 'DEBUG': console.debug(message); break;
        case 'WARNING': console.warn(message); break;
        default: console.log(message);
      }
    },
      
    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —á–∏—Å–ª–æ –∫–∞–∫ –≤–∞–ª—é—Ç—É –±–µ–∑ —Å–∏–º–≤–æ–ª–∞ –≤–∞–ª—é—Ç—ã.
     */
    formatBalance(amount) {
      const numAmount = (typeof amount === 'string') ? parseFloat(amount) : amount;
      if (numAmount === undefined || numAmount === null || isNaN(numAmount)) return '-';
      
      return new Intl.NumberFormat('ru-RU', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
        useGrouping: true
      }).format(numAmount);
    },
    
    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
     */
    handleTransactionsUpdate() {
      this.loadAccounts();
    },
    
    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫–ª—é—á –º–µ—Å—è—Ü–∞ "YYYY-MM" –≤ "–ú–µ—Å—è—Ü".
     */
    formatMonthYear(monthKey) {
      if (!monthKey || !monthKey.includes('-')) return monthKey;
      
      try {
        const [year, month] = monthKey.split('-');
        const date = new Date(parseInt(year), parseInt(month) - 1, 1);
        return date.toLocaleString('ru-RU', { month: 'long' });
      } catch (e) {
        console.error("Error formatting month key:", monthKey, e);
        return monthKey;
      }
    },
    
    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —á–∏—Å–ª–æ –¥–ª—è title –∞—Ç—Ä–∏–±—É—Ç–∞.
     */
    formatValueForTitle(value) {
      const num = parseFloat(value);
      if (isNaN(num)) {
        return '0.00';
      }
      return num.toFixed(2);
    },
    
    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è —Å—á–µ—Ç–∞
     */
    toggleTransactions(accountId) {
      this.expandedAccountId = this.expandedAccountId === accountId ? null : accountId;
    },
    
    /**
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
     */
     showAddTransaction(accountId, accountName) {
      this.selectedAccountForModal = this.accounts.find(acc => acc.id === accountId) || 
                                     { id: accountId, name: accountName || '–°—á—ë—Ç' };
      this.showingAddTransaction = true;
      this.showingCreateAccount = false;
      this.showingGlobalRateModal = false;
      this.log("–û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.", 'INFO');
    },
    
    /**
     * –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
     */
     closeAddTransaction() {
      this.showingAddTransaction = false;
      this.selectedAccountForModal = null;
      this.log("–ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.", 'INFO');
    },
    
    /**
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞
     */
     showCreateAccount() {
      this.showingCreateAccount = true;
      this.showingAddTransaction = false;
      this.showingGlobalRateModal = false;
      this.log("–û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á—ë—Ç–∞.", 'INFO');
    },
    
    /**
     * –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞
     */
     closeCreateAccount() {
      this.showingCreateAccount = false;
      this.log("–ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á—ë—Ç–∞.", 'INFO');
    },
    
    /**
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å—Ç–∞–≤–∫–∏
     */
     showGlobalRateModal() {
      this.fetchCurrentMonthRate();
      this.rateChangeError = null;
      this.showingGlobalRateModal = true;
      this.showingAddTransaction = false;
      this.showingCreateAccount = false;
      this.log("–û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∏.", 'INFO');
    },
    
    /**
     * –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å—Ç–∞–≤–∫–∏
     */
     closeGlobalRateModal() {
      this.showingGlobalRateModal = false;
      this.newInterestRate = null;
      this.rateChangeError = null;
      this.log("–ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∏.", 'INFO');
    },
    
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Å—Ç–∞–≤–∫—É –º–µ—Å—è—Ü–∞ –¥–ª—è –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª—è
     */
     async fetchCurrentMonthRate() {
      try {
        const response = await axios.get(`/api/interest-rate/${this.currentMonthStr}`);
        if (response.data && response.data.rate !== undefined) {
          this.newInterestRate = response.data.rate;
          this.log("–ü–æ–ª—É—á–µ–Ω–∞ —Ç–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞ –º–µ—Å—è—Ü–∞.", 'INFO');
        } else {
          this.newInterestRate = null;
          this.log("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç–∞–≤–∫—É –º–µ—Å—è—Ü–∞.", 'WARNING');
        }
      } catch (error) {
        this.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–µ–∫—É—â–µ–π —Å—Ç–∞–≤–∫–∏ –º–µ—Å—è—Ü–∞.", 'ERROR');
        this.newInterestRate = null;
      }
    },
    
    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å—á–µ—Ç–∞
     */
     async onActionComplete() {
      this.closeAddTransaction();
      this.closeCreateAccount();
      await this.loadAccounts();
      this.log("–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.", 'INFO');
    },
    
    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É
     */
     async saveGlobalInterestRate() {
      if (this.newInterestRate === null || this.newInterestRate === undefined || this.newInterestRate < 0) {
        this.rateChangeError = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—É—é —Å—Ç–∞–≤–∫—É.";
        this.log("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–∞–≤–∫–∞ –≤–≤–µ–¥–µ–Ω–∞.", 'WARNING');
        return;
      }

      this.rateChangeError = null;
      const ratePayload = { rate: this.newInterestRate };
      const monthToUpdate = this.currentMonthStr;

      try {
        await axios.put(`/api/interest-rate/${monthToUpdate}`, ratePayload);
        this.closeGlobalRateModal();
        await this.loadAccounts();
        this.log("–°—Ç–∞–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.", 'INFO');
      } catch (error) {
        this.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞–≤–∫–∏.", 'ERROR');
        this.rateChangeError = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞–≤–∫–∏: ' + 
                             (error.response?.data?.detail || error.message);
      }
    },
    
    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å—á–µ—Ç–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
     */
     async loadAccounts() {
      this.loading = true;
      this.error = null;

      setTimeout(() => {
        if (this.loading) {
          this.log('Force ending loading state after timeout.', 'INFO');
          this.loading = false;
          this.error = 'Request timed out. Please check server connectivity.';
        }
      }, 10000); // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç

      try {
        const startTime = performance.now();
        const response = await axios.get('/api/accounts');
        const endTime = performance.now();

        this.log(`–ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω –∑–∞ ${(endTime - startTime).toFixed(2)}ms`, 'INFO');
        this.log("–û—Ç–≤–µ—Ç API:", response.status, response.statusText, 'INFO');

        if (response.data) {
          this.log(`–ü–æ–ª—É—á–µ–Ω–æ ${Array.isArray(response.data) ? response.data.length : '–Ω–µ –º–∞—Å—Å–∏–≤'} –∑–∞–ø–∏—Å–µ–π`, 'INFO');
          if (Array.isArray(response.data) && response.data.length > 0) {
            this.log("–ü—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏:", JSON.stringify(response.data[0], null, 2), 'DEBUG');
          } else {
            this.log("–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:", response.data, 'DEBUG');
          }
        } else {
          this.log("–û—Ç–≤–µ—Ç API –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö", 'WARNING');
        }

        this.accounts = response.data;
      } catch (error) {
        this.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—á–µ—Ç–æ–≤.", 'ERROR');
        this.log("–¢–∏–ø –æ—à–∏–±–∫–∏:", error.name, 'ERROR');
        this.log("–°–æ–æ–±—â–µ–Ω–∏–µ:", error.message, 'ERROR');

        if (error.response) {
          this.log("–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:", error.response.status, 'ERROR');
          this.log("–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:", error.response.data, 'ERROR');
        } else if (error.request) {
          this.log("–ó–∞–ø—Ä–æ—Å –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –Ω–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω", 'ERROR');
        } else {
          this.log("–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –∑–∞–ø—Ä–æ—Å–∞", 'ERROR');
        }

        this.error = (error.response?.data?.detail || error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        this.accounts = [];
      } finally {
        this.loading = false;
        this.log("–°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:", {
          loading: this.loading,
          error: this.error,
          accountsCount: Array.isArray(this.accounts) ? this.accounts.length : '–Ω–µ –º–∞—Å—Å–∏–≤'
        }, 'INFO');
      }
    }

  },

  async created() {
    await this.loadAccounts();
  }
};
</script>